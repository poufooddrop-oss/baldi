<!DOCTYPE html>
<html lang="en-us">

<head>
    <base href="https://cdn.jsdelivr.net/gh/genizy/web-port@main/baldi-plus/">
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Baldi's Basics Plus</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            border: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #231F20;
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #fullscreen-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 16px;
            font-family: sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #fullscreen-btn:hover {
            background: white;
            color: black;
        }

        /* Password overlay */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #231F20;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            z-index: 10000;
        }

        #password-input {
            font-size: 18px;
            padding: 8px;
            margin-top: 10px;
            border-radius: 5px;
            border: none;
            text-align: center;
        }

        #password-btn {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            border: none;
            background: white;
            color: black;
        }

        #error-msg {
            color: red;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <!-- Password Screen -->
    <div id="password-overlay">
        <h2>Enter Password</h2>
        <input type="password" id="password-input" placeholder="Password">
        <button id="password-btn">Enter</button>
        <div id="error-msg">Incorrect password.</div>
    </div>

    <div id="loading-text"
        style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px; display:none;">
        LOADING...
    </div>

    <canvas id="unity-canvas" tabindex="-1" style="display:none;"></canvas>
    <button id="fullscreen-btn" style="display:none;">â›¶ Fullscreen</button>

    <script src="Build/Export.loader.js"></script>
    <script>
        // Password protection
        const overlay = document.getElementById("password-overlay");
        const input = document.getElementById("password-input");
        const button = document.getElementById("password-btn");
        const errorMsg = document.getElementById("error-msg");

        button.addEventListener("click", () => {
            if (input.value === "plus29") {
                overlay.style.display = "none";
                document.getElementById("loading-text").style.display = "block";
                document.getElementById("unity-canvas").style.display = "block";
                document.getElementById("fullscreen-btn").style.display = "block";
                startGame();
            } else {
                errorMsg.style.display = "block";
            }
        });

        function startGame() {
            const loadingText = document.querySelector("#loading-text");
            const fullscreenBtn = document.querySelector("#fullscreen-btn");
            const unityCanvas = document.querySelector("#unity-canvas");
            let totalBytes = 0;
            let loadedBytes = 0;

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && document.fullscreenElement) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);

            fullscreenBtn.addEventListener("click", () => {
                if (!document.fullscreenElement) {
                    unityCanvas.requestFullscreen().catch(err => {
                        alert(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                    fullscreenBtn.textContent = "ðŸ—— Exit Fullscreen";
                } else {
                    document.exitFullscreen();
                    fullscreenBtn.textContent = "â›¶ Fullscreen";
                }
            });

            document.addEventListener("fullscreenchange", () => {
                if (!document.fullscreenElement) {
                    fullscreenBtn.textContent = "â›¶ Fullscreen";
                } else {
                    fullscreenBtn.textContent = "ðŸ—— Exit Fullscreen";
                }
            });

            function formatSize(bytes) {
                if (bytes > 1024 * 1024 * 1024) return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
                else if (bytes > 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + " MB";
                else if (bytes > 1024) return (bytes / 1024).toFixed(2) + " KB";
                else return bytes + " B";
            }

            async function getSize(url) {
                try {
                    const res = await fetch(url, { method: "HEAD" });
                    return parseInt(res.headers.get("Content-Length") || "0", 10);
                } catch {
                    return 0;
                }
            }

            async function fetchWithProgress(url) {
                const response = await fetch(url);
                const reader = response.body.getReader();
                let chunks = [];
                let received = 0;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    received += value.length;
                    loadedBytes += value.length;
                    chunks.push(value);
                    const doneText = formatSize(loadedBytes);
                    const totalText = formatSize(totalBytes);
                    const percent = totalBytes > 0 ? ((loadedBytes / totalBytes) * 100).toFixed(1) : "?";
                    loadingText.textContent = `LOADING... ${doneText} / ${totalText} (${percent}%)`;
                }
                let fullBuffer = new Uint8Array(received);
                let offset = 0;
                for (let chunk of chunks) {
                    fullBuffer.set(chunk, offset);
                    offset += chunk.length;
                }
                return fullBuffer.buffer;
            }

            async function mergeFiles(parts) {
                const buffers = await Promise.all(parts.map(fetchWithProgress));
                return URL.createObjectURL(new Blob(buffers));
            }

            function getParts(file, count) {
                let parts = [];
                for (let i = 1; i <= count; i++) {
                    parts.push(file + ".part" + i);
                }
                return parts;
            }

            (async () => {
                const dataParts = getParts("Build/Export.data", 2);
                const wasmParts = getParts("Build/Export.wasm", 3);
                const allParts = [...dataParts, ...wasmParts];
                const sizes = await Promise.all(allParts.map(getSize));
                totalBytes = sizes.reduce((a, b) => a + b, 0);
                const [dataUrl, wasmUrl] = await Promise.all([
                    mergeFiles(dataParts),
                    mergeFiles(wasmParts)
                ]);
                createUnityInstance(unityCanvas, {
                    dataUrl: dataUrl,
                    frameworkUrl: "Build/Export.framework.js",
                    codeUrl: wasmUrl,
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "Basically Games",
                    productName: "Baldi's Basics Plus",
                    productVersion: "0.3.2",
                }).then(() => {
                    loadingText.remove();
                });
            })();
        }
    </script>
</body>
</html>

