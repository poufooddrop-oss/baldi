<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <title>Protected Page</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            border: 0;
            height: 100%;
            width: 100%;
            background: #231F20;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* Centered password screen */
        #password-screen {
            position: fixed;
            inset: 0;
            background: #231F20;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        #password-screen h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        #password-input {
            padding: 10px;
            font-size: 18px;
            border-radius: 6px;
            border: none;
            text-align: center;
        }

        #password-btn {
            margin-top: 15px;
            padding: 8px 16px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            background: white;
            color: black;
            cursor: pointer;
        }

        #password-btn:hover {
            background: #ddd;
        }

        #error-msg {
            color: red;
            margin-top: 10px;
            display: none;
        }

        /* Hide the main content initially */
        #main-content {
            display: none;
        }
    </style>
</head>

<body>
    <!-- PASSWORD SCREEN -->
    <div id="password-screen">
        <h2>Enter Password</h2>
        <input type="password" id="password-input" placeholder="Password">
        <button id="password-btn">Enter</button>
        <div id="error-msg">Incorrect password.</div>
    </div>

    <!-- MAIN CONTENT (hidden until correct password) -->
    <div id="main-content">
        <base href="https://cdn.jsdelivr.net/gh/genizy/web-port@main/baldi-plus/">
        <div id="loading-text"
            style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;">
            LOADING...
        </div>

        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <button id="fullscreen-btn">â›¶ Fullscreen</button>

        <script src="Build/Export.loader.js"></script>
        <script>
            // This entire section only runs AFTER password entry
            function startGame() {
                const loadingText = document.querySelector("#loading-text");
                const fullscreenBtn = document.querySelector("#fullscreen-btn");
                const unityCanvas = document.querySelector("#unity-canvas");
                let totalBytes = 0;
                let loadedBytes = 0;

                fullscreenBtn.addEventListener("click", () => {
                    if (!document.fullscreenElement) {
                        unityCanvas.requestFullscreen().catch(err => {
                            alert(`Error attempting to enable fullscreen: ${err.message}`);
                        });
                        fullscreenBtn.textContent = "ðŸ—— Exit Fullscreen";
                    } else {
                        document.exitFullscreen();
                        fullscreenBtn.textContent = "â›¶ Fullscreen";
                    }
                });

                function formatSize(bytes) {
                    if (bytes > 1024 * 1024 * 1024) return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
                    else if (bytes > 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + " MB";
                    else if (bytes > 1024) return (bytes / 1024).toFixed(2) + " KB";
                    else return bytes + " B";
                }

                async function getSize(url) {
                    try {
                        const res = await fetch(url, { method: "HEAD" });
                        return parseInt(res.headers.get("Content-Length") || "0", 10);
                    } catch {
                        return 0;
                    }
                }

                async function fetchWithProgress(url) {
                    const response = await fetch(url);
                    const reader = response.body.getReader();
                    let chunks = [];
                    let received = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        received += value.length;
                        loadedBytes += value.length;
                        chunks.push(value);
                        const doneText = formatSize(loadedBytes);
                        const totalText = formatSize(totalBytes);
                        const percent = totalBytes > 0 ? ((loadedBytes / totalBytes) * 100).toFixed(1) : "?";
                        loadingText.textContent = `LOADING... ${doneText} / ${totalText} (${percent}%)`;
                    }
                    let fullBuffer = new Uint8Array(received);
                    let offset = 0;
                    for (let chunk of chunks) {
                        fullBuffer.set(chunk, offset);
                        offset += chunk.length;
                    }
                    return fullBuffer.buffer;
                }

                async function mergeFiles(parts) {
                    const buffers = await Promise.all(parts.map(fetchWithProgress));
                    return URL.createObjectURL(new Blob(buffers));
                }

                function getParts(file, count) {
                    let parts = [];
                    for (let i = 1; i <= count; i++) {
                        parts.push(file + ".part" + i);
                    }
                    return parts;
                }

                (async () => {
                    const dataParts = getParts("Build/Export.data", 2);
                    const wasmParts = getParts("Build/Export.wasm", 3);
                    const allParts = [...dataParts, ...wasmParts];
                    const sizes = await Promise.all(allParts.map(getSize));
                    totalBytes = sizes.reduce((a, b) => a + b, 0);
                    const [dataUrl, wasmUrl] = await Promise.all([
                        mergeFiles(dataParts),
                        mergeFiles(wasmParts)
                    ]);
                    createUnityInstance(unityCanvas, {
                        dataUrl: dataUrl,
                        frameworkUrl: "Build/Export.framework.js",
                        codeUrl: wasmUrl,
                        streamingAssetsUrl: "StreamingAssets",
                        companyName: "Basically Games",
                        productName: "Baldi's Basics Plus",
                        productVersion: "0.3.2",
                    }).then(() => {
                        loadingText.remove();
                    });
                })();
            }
        </script>
    </div>

    <script>
        const input = document.getElementById("password-input");
        const button = document.getElementById("password-btn");
        const errorMsg = document.getElementById("error-msg");

        button.addEventListener("click", () => {
            if (input.value === "plus29") {
                document.getElementById("password-screen").style.display = "none";
                document.getElementById("main-content").style.display = "block";
                startGame();
            } else {
                errorMsg.style.display = "block";
            }
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") button.click();
        });
    </script>
</body>

</html>
